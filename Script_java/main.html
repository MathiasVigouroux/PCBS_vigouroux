<!DOCTYPE html>
<head>
  <title>A simple jsPsych experiment</title>
</head>
<body>
  <script src = "../jspsych-7.3.0/dist/jspsych.js"></script>
  <script src = "../jspsych-7.3.0/dist/plugin-html-keyboard-response.js"></script>
  <script src = "../jspsych-7.3.0/dist/plugin-html-keyboard-response.js"></script>

  <script>


// A faire : pour le moment il n'y a q'un seul block. Faire différentes distribution
// Initialisation de JsPsych

    const jsPsych = initJsPsych({
      on_finish: function(){jsPsych.data.get().localSave('csv', `data-${ID}.csv`)}
    });

    const ID = jsPsych.randomization.randomID(10)
    const INSTRUCTIONS = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: `\
        <p>A series of tones will be presented.</p>\
        <p>There will be a pair of tone \
          </p>`,
      data: {id: ID},
    };


// Variables de durée 
    var bip_duration = 1000 // in milliseconds
    var max_target = 2000
    var feedback_duration= 1000
    var very_good = 500
    var middle = 1000
    var too_long = 2000

    experiment_duration= 5 // experiment duration

    
// appeler ça des CONST et ecrire leur nom en majuscule
// Initialisationb des bips 
    function playCueSound(){
      var frequency = 440.0
      var context = new AudioContext()
      var o = context.createOscillator()
      o.frequency.value = frequency
      var  g = context.createGain()
      o.connect(g)
      g.connect(context.destination)
      o.start(0)
      g.gain.exponentialRampToValueAtTime(
      0.00001, context.currentTime + bip_duration/1000
      )
    };

    function playTargetSound(){
      var frequency = 2000.0
      var context = new AudioContext()
      var o = context.createOscillator()
      o.frequency.value = frequency
      var  g = context.createGain()
      o.connect(g)
      g.connect(context.destination)
      o.start(0)
      g.gain.exponentialRampToValueAtTime(
      0.00001, context.currentTime + bip_duration/1000
      )
    };

//-----------Cue and Target Sound
    var cue = {
      type: jsPsychHtmlKeyboardResponse, 
      stimulus: "cue",
      on_start: function(){
        return playCueSound()
      },
      trial_duration: bip_duration,
      choices: "NO_KEYS"
    }

    var target = {
      type: jsPsychHtmlKeyboardResponse, 
      stimulus: "target",
      on_start: function(){
        return playTargetSound()
      },
      trial_duration: bip_duration + too_long ,
      choices: ["k"],

      //data : {feed}
    }

    var feedback = {
      type: jsPsychHtmlKeyboardResponse, 
      
      stimulus: function(){
        reaction_time = jsPsych.data.get().last(1).values()[0].rt
        if  (reaction_time == null ){return 'too long'}
        else if (reaction_time < very_good){return 'green'}
        else if (reaction_time >= very_good  && reaction_time < middle){return 'orange'}
        else if  (reaction_time >= middle  && reaction_time < too_long){return 'red'}
        

      },
      trial_duration: feedback_duration ,
      choices: "NO_KEYS"
      
    }

//----------ISI A faire : faire le ISI dans exponential distribution
var ISI={
      type: jsPsychHtmlKeyboardResponse, 
      stimulus: "ISI",
      trial_duration: 2000,
      choices: "NO_KEYS"
  };

//----------Creation of the Foreperiods: changer la smple distrbution uniform en ditribution gaussienne 
 
    function getRandomArbitrary(min, max) {
        return Math.random() * (max - min) + min;
    } // defintion of a fnction to have random trial (not normal for the moment just uniform)


    function getRandomNormal(mean, standardDeviation) {
      // creation of a normal distrbution from the polar box muller transform
      let u = 0; 
      let v = 0;
      let s = 0;
      
      do {
        u = Math.random() * 2 - 1;
        v = Math.random() * 2 - 1;
        s = u * u + v * v;
      } while (s >= 1 || s === 0);
      
      const multiplier = Math.sqrt(-2 * Math.log(s) / s);
      const randomNumber = mean + standardDeviation * u * multiplier;
      
      return randomNumber;
    }

    

    fp_dur_list= []
    for (let i=0; i<= experiment_duration; i++){
      fp_dur=  getRandomNormal(2.5,0.7)//getRandomArbitrary(1000, 6000)
      fp_dur_list.push(fp_dur)
    }


    fp_list= []
    for (let i=0; i<= experiment_duration; i++){
      fp = {
      type: jsPsychHtmlKeyboardResponse, 
      stimulus: "fp",
      trial_duration: fp_dur_list[i],
      choices: "NO_KEYS",
      }
      fp_list.push(fp)
    }

  var tooEarly = {
      type: jsPsychHtmlKeyboardResponse, 
      stimulus: "Too early",
      trial_duration: 1,
      choices: ["k"],
  }

  var condEarly = {
    timeline: [tooEarly],
    conditional_function: function(){
      if (responseEarly = true ){
        return true 
      }
    },
  }

   
    //stim = jsPsych.randomization.shuffleNoRepeats(stim);

    let timeline = [];
    
    for (let i = 0; i < fp_list.length; i++) {           
        timeline.push(cue);
        timeline.push(fp_list[i]);
        timeline.push(target);
        timeline.push(feedback);
        timeline.push(ISI);
                    }


    
    jsPsych.run([INSTRUCTIONS].concat(timeline));

    </script>
</body>
